<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">

<head>
  <meta charset="utf-8" />
  <title>Useit.se status</title>
  <style>
    :root {
      --beige: #fbf3df;
      --blue: #7ca7ba;
      --green: #a9d9b3;
      --darkblue: #276078;
      --darkerblue: #0A4B67;
      --lightblue: #cce4f4;
      --yellow: #f0c868;
      --red: #f7a7a4;
      --darkred: #be4350;
      --success: #0070f3;
      --cyan: #79FFE1;
      --grey: #efefef;
      --white: #fff;
    }

    :root {
      --text-color: #111;
      --bg-color: #fefefe;
      --accent-color: var(--beige);
      --button-color: var(--darkred);
      --bg-alt: var(--light-blue);
      --bg-grey: var(--grey);
      --border-color: #999;
      --blue-color: var(--blue);
      --light-blue: var(--light-blue);
      --focus-color: var(--darkerblue);
    }

    @media screen and (prefers-color-scheme: dark) {
      :root {
        --text-color: #fff;
        --bg-color: #0e1220;
        --accent-color: #171f2e;
        --button-color: #be4350;
        --bg-alt: #171f2e;
        --bg-grey: #efefef;
        --border-color: #666;
        --blue-color: #171f2e;
        --light-blue: #171f2e;
        --focus-color: #fff;
      }
    }

    body {
      background-color: var(--blue-color);
      color: var(--text-color);
      font-family:
              "Segoe UI",
              Roboto,
              "Noto Sans",
              Ubuntu,
              Cantarell,
              "Helvetica Neue",
              sans-serif;
      font-size: 100%;
      line-height: 1.3rem;
      margin: 0;
      padding: 0;
    }

    main {
      margin: 0 auto;
      max-width: 1000px;
      padding: 1.25rem;
      text-align: center;
      margin-top: 3rem;
    }

    h1 {
      font-size: 2.5rem;
      line-height: 1.5rem;
      margin: 0;
      margin-bottom: 0.75rem;
    }

    h2 {
      font-size: 1.15rem;
      font-weight: normal;
      margin: 0 0 0.75rem;
    }

    p {
      margin: 0;
    }

    .button:hover {
      cursor: pointer;
    }

    .links {
      display: flex;
      flex-direction: row;
      justify-content: center;
      gap: 2rem;
      margin-top: 3rem;
    }

    .links li {
      font-size: 1.3rem;
      list-style: none;
      margin: 0;
      padding: 3rem;
      font-weight: 700;
      border-radius: 8px;
      background-color: var(--bg-color);

    }
    .links a[href] {
      height: 100%;
      color: var(--text-color);
      text-decoration: none;
    }

    .links a[href]:hover, .links a[href]:focus {
      text-underline-offset: 0.2em;
      text-decoration: underline;
    }

    .e2e-link.success, .a11y-link.success {
      box-shadow: inset 0 0 0 8px var(--green);
    }

    .e2e-link.failure, .a11y-link.failure {
      box-shadow: inset 0 0 0 8px var(--red);
    }

    .e2e-link.success .result, .a11y-link.success .result, .e2e-link.failure .result, .a11y-link.failure .result {
        font-size: 1rem;
        font-weight: 400;
        opacity: 0.8;
        margin-top: 1rem;
    }

  </style>
</head>

<body>
<main>
  <h1>Useit.se status</h1>
  <ul class="links">
    <li class="a11y-link">
      <a href="a11y">
        Pa11y accessibility tests
      </a>
      <div class="result"></div>
    </li>
    <li class="e2e-link">
      <a href="e2e">
        Playwright end-to-end tests
      </a>
      <div class="result"></div>
    </li>
  </ul>



</main>
<script>
  let accessToken = undefined
  fetch("/.netlify/functions/get-github-pat")
          .then(response => response.json())
          .then(data => {
            accessToken = data.body;
            console.log(accessToken);
          });


  const headers = new Headers({
    "Authorization": `Token ${accessToken}`,
    "Accept": "application/vnd.github+json"
  });

  async function getWorkflows(repoOwner, repoName) {
    const response = await fetch(
            `https://api.github.com/repos/${repoOwner}/${repoName}/actions/workflows`,
            {
              headers,
            }
    );

    if (!response.ok) {
      console.error("Failed to retrieve workflows");
      return;
    }

    const workflows = await response.json();
    console.log(workflows);
  }

  getWorkflows("fymmot", "useit-next");

  const getLastRun = async (workflowName) => {
    const res = await fetch(`https://api.github.com/repos/fymmot/useit-next/actions/workflows/${workflowName}/runs`, { headers });
    const data = await res.json();
    return data.workflow_runs[0].id;
  };

  const getRunStatus = async (runId) => {
    const res = await fetch(`https://api.github.com/repos/fymmot/useit-next/actions/runs/${runId}`, { headers });
    const data = await res.json();
    return { date: data.updated_at, status: data.conclusion };
  };

  const displayStatus = async (workflowName) => {
    const runId = await getLastRun(workflowName);
    const status = await getRunStatus(runId);
    return status
  };

  let pa11yStatus = undefined;
  let e2eStatus = undefined;

  const getStatusString = (status, date) => {
    const formattedDateTime = new Date(date).toLocaleString("sv-SE", {
      dateStyle: "short",
      timeStyle: "short",
    });

    if (status === "success") {
      return `Last run: ${formattedDateTime} - Success`;
    }
    if (status === "failure") {
      return `Last run: ${formattedDateTime} - Failure`;
    }
  };

  displayStatus(43311163).then((status) => {
    pa11yStatus = status.status;
    const pa11yLink = document.getElementsByClassName("a11y-link")[0];
    pa11yLink.classList.add(pa11yStatus);
    pa11yLink.getElementsByClassName("result")[0].innerHTML = getStatusString(status.status, status.date);

  });
  displayStatus(47259483).then((status) => {
    e2eStatus = status.status;
    const e2eLink = document.getElementsByClassName("e2e-link")[0];
    e2eLink.classList.add(e2eStatus);
    e2eLink.getElementsByClassName("result")[0].innerHTML = getStatusString(status.status, status.date);
  });

</script>
</body>

</html>
